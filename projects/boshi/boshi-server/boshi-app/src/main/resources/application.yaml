# Boshi SMTP Server - Base Configuration
# This file is committed to git and contains:
# - Default values for all environments
# - Configuration structure documentation
# - Public, non-sensitive defaults
#
# Secrets are provided via environment variables:
# - ${DB_PASSWORD} → resolved from DB_PASSWORD env var
# - ${BOSHI_API_KEY} → resolved from BOSHI_API_KEY env var

ktor:
  application:
    modules:
      - com.ead.boshi.app.ApplicationKt.main

  deployment:
    # Network Configuration
    host: ${SERVER_HOST:0.0.0.0}
    port: ${SERVER_PORT:8081}
    #sslPort: ${SERVER_SSL_PORT:}  # Optional: set to enable HTTPS (e.g., 8443)

    # Shutdown Configuration
    shutdownGracePeriod: ${SHUTDOWN_GRACE_PERIOD:1000}      # ms
    shutdownTimeout: ${SHUTDOWN_TIMEOUT:5000}               # ms
    shutdownUrl: ${SHUTDOWN_URL:}                           # Optional: endpoint for graceful shutdown

    # Context & Routing
    rootPath: ${ROOT_PATH:/}
    # watchPaths: []  # Optional: watch paths for auto-reload during development

    # Thread Pool Configuration (mainly Netty, but defined here for consistency)
    connectionGroupSize: ${CONNECTION_GROUP_SIZE:8}         # Threads for accepting connections
    workerGroupSize: ${WORKER_GROUP_SIZE:8}                 # Threads for message parsing
    callGroupSize: ${CALL_GROUP_SIZE:8}                     # Threads for application code

    # HTTP Protocol Limits
    maxInitialLineLength: ${MAX_INITIAL_LINE_LENGTH:4096}   # bytes
    maxHeaderSize: ${MAX_HEADER_SIZE:8192}                  # bytes
    maxChunkSize: ${MAX_CHUNK_SIZE:8192}                    # bytes

    # Timeout Configuration
    connectionIdleTimeoutMs: ${CONNECTION_IDLE_TIMEOUT:180000}  # 3 minutes, ms
    requestTimeoutMs: ${REQUEST_TIMEOUT:}                       # Optional: max time to process request

    # Jetty-specific Thread Pools (optional, ignored by other engines)
    maxThreads: ${MAX_THREADS:}                              # Optional: Jetty max threads
    minThreads: ${MIN_THREADS:}                              # Optional: Jetty min threads

  #security:
    #ssl:
      # SSL Configuration (only set if sslPort is configured above)
      # keyStore: "path/to/keystore.jks"
      # keyAlias: "server-alias"
      # keyStorePassword: ${SSL_KEY_STORE_PASSWORD:}
      # privateKeyPassword: ${SSL_PRIVATE_KEY_PASSWORD:}
      # Optional SSL provider and factory settings
      # provider: "SunX509"
      # keyManagerFactory: "SunX509"
      # trustManagerFactory: "SunX509"
      # trustStore: "path/to/truststore.jks"
      # trustStorePassword: ${SSL_TRUST_STORE_PASSWORD:}

# Database Configuration
# Environment variables: DB_URL, DB_USERNAME, DB_PASSWORD, DB_DRIVER
database:
  url: ${DB_URL:jdbc:postgresql://localhost:5432/postgres}
  username: ${DB_USERNAME:postgres}
  password: ${DB_PASSWORD:}
  driver: ${DB_DRIVER:org.postgresql.Driver}
  pool:
    maxSize: ${DB_MAX_POOL:10}
    minIdle: ${DB_MIN_IDLE:1}
    connectionTimeout: ${DB_TIMEOUT:30000}
    idleTimeout: ${DB_IDLE_TIMEOUT:600000}
    maxLifetime: ${DB_MAX_LIFETIME:1800000}

authentication:
  api-key: ${BOSHI_API_KEY:12345}

# Rate Limiting Configuration
# Uses Ktor's built-in RateLimit plugin for API protection
rateLimit:
  enabled: ${RATE_LIMIT_ENABLED:true}
  requestsPerSecond: ${RATE_LIMIT_RPS:10}          # Global: max 10 requests/sec
  refillPeriodSeconds: ${RATE_LIMIT_REFILL:1}      # Token refill period
  initialTokens: ${RATE_LIMIT_TOKENS:10}           # Initial burst tokens
  emailSendLimit: ${RATE_LIMIT_EMAIL_SEND:100}    # POST /emails/send: 100 req/min
  statusCheckLimit: ${RATE_LIMIT_STATUS:100}      # GET /status: 100 req/min

# SMTP Client Configuration - for outbound email delivery
# Used by SmtpConfigLoader (AutomaticServiceConfigLoader)
# Environment variables: SMTP_HOST, SMTP_PORT, SMTP_USERNAME, SMTP_PASSWORD, SMTP_USE_TLS, SMTP_CONNECTION_TIMEOUT, SMTP_READ_TIMEOUT
smtp:
  # Client configuration (for sending emails via external SMTP server)
  # Default: Gmail SMTP (requires authentication)
  # For Gmail: Use app password from https://myaccount.google.com/apppasswords
  host: ${SMTP_HOST:smtp.gmail.com}
  port: ${SMTP_PORT:587}
  localHostname: ${SMTP_LOCAL_HOSTNAME:boshi.local}
  username: ${SMTP_USERNAME:xavier.torres.ac@gmail.com}
  password: ${SMTP_PASSWORD:}
  useTls: ${SMTP_USE_TLS:true}
  connectionTimeoutSeconds: ${SMTP_CONNECTION_TIMEOUT:30}
  readTimeoutSeconds: ${SMTP_READ_TIMEOUT:30}

  # Server configuration
  server:
    name: ${SMTP_SERVER_NAME:mail.boshi.local}
    maxConnections: ${SMTP_MAX_CONNECTIONS:100}
    connectionTimeoutSeconds: ${SMTP_TIMEOUT:30}
  delivery:
    maxRetries: ${SMTP_MAX_RETRIES:3}
    retryDelaySeconds: ${SMTP_RETRY_DELAY:300}
  validation:
    validateEmailFormat: ${SMTP_VALIDATE_FORMAT:true}
    validateDomain: ${SMTP_VALIDATE_DOMAIN:true}
    enableSpamDetection: ${SMTP_SPAM_DETECTION:true}
    spamScoreThreshold: ${SMTP_SPAM_THRESHOLD:7.0}
  storage:
    retentionDays: ${SMTP_RETENTION_DAYS:14}
    cleanupBatchSize: ${SMTP_CLEANUP_BATCH:1000}
    cleanupSchedule: ${SMTP_CLEANUP_SCHEDULE:"0 2 * * * ?"}

# DNS Configuration
# Environment variables: DNS_SERVERS, DNS_MX_CACHE_HOURS, DNS_MX_TIMEOUT
dns:
  servers: ${DNS_SERVERS:8.8.8.8,8.8.4.4}
  mxCacheHours: ${DNS_MX_CACHE_HOURS:24}
  mxLookupTimeoutSeconds: ${DNS_MX_TIMEOUT:10}

# Application Environment
# Used by validators to apply environment-specific rules
app:
  environment: ${APP_ENVIRONMENT:development}
  debug: ${APP_DEBUG:true}
